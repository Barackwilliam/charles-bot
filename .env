<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charles Academy - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #0088cc;
            --primary-light: #ebf5ff;
            --secondary: #00a884;
            --danger: #eb4d4b;
            --warning: #f9ca24;
            --success: #2ecc71;
            --dark: #0e1621;
            --dark-light: #17212b;
            --text: #ffffff;
            --text-secondary: #8f98a3;
            --border: #2b2b2b;
            --sidebar-width: 250px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--dark);
            color: var(--text);
            line-height: 1.6;
        }

        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark-light);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        .logo-container {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .logo-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .nav-menu {
            list-style: none;
            padding: 0 15px;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .nav-link.active {
            background: rgba(0, 136, 204, 0.15);
            color: var(--primary);
            border-left: 3px solid var(--primary);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 5px;
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--dark-light);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-name {
            font-weight: 500;
            font-size: 14px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark-light);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--text);
        }

        .stat-change {
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: var(--dark-light);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        /* Tables */
        .table-container {
            background: var(--dark-light);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px 15px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 14px;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(46, 204, 113, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(249, 202, 36, 0.15);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(235, 77, 75, 0.15);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(0, 136, 204, 0.15);
            color: var(--primary);
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #0077b3;
        }

        .btn-secondary {
            background: var(--dark-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Search and Filters */
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            background: var(--dark-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark-light);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                padding: 20px 0;
            }

            .logo-text, .logo-subtitle, .nav-link span {
                display: none;
            }

            .logo {
                justify-content: center;
            }

            .main-content {
                margin-left: 70px;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: var(--border);
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div>
                        <div class="logo-text">Charles Academy</div>
                        <div class="logo-subtitle">Admin Dashboard</div>
                    </div>
                </div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#students" class="nav-link" onclick="showSection('students')">
                        <i class="fas fa-users"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#exams" class="nav-link" onclick="showSection('exams')">
                        <i class="fas fa-file-alt"></i>
                        <span>Exams & Results</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#messages" class="nav-link" onclick="showSection('messages')">
                        <i class="fas fa-comments"></i>
                        <span>Messages</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#progress" class="nav-link" onclick="showSection('progress')">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress Analytics</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#settings" class="nav-link" onclick="showSection('settings')">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <h1 id="pageTitle">Dashboard Overview</h1>
                    <p id="pageSubtitle">Loading data from Supabase...</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-avatar">CA</div>
                        <div class="user-name" id="userName">Loading...</div>
                    </div>
                    <button class="btn btn-secondary" onclick="refreshData()" title="Refresh Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="dashboard-section">
                <!-- Stats Cards -->
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Student Enrollment</div>
                            <select id="enrollmentPeriod" class="form-control" style="width: auto; padding: 5px 10px;" onchange="loadEnrollmentData()">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <canvas id="enrollmentChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Exam Performance</div>
                            <select id="examPeriod" class="form-control" style="width: auto; padding: 5px 10px;" onchange="loadPerformanceData()">
                                <option value="week">This Week</option>
                                <option value="month" selected>This Month</option>
                                <option value="quarter">This Quarter</option>
                            </select>
                        </div>
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-history"></i>
                        Recent Activity
                    </div>
                    <div id="recentActivity">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Students Section -->
            <section id="students" class="dashboard-section" style="display: none;">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search students by name, phone, or ID..." 
                           onkeyup="searchStudents(this.value)">
                    <button class="btn btn-primary" onclick="showAddStudentModal()">
                        <i class="fas fa-plus"></i> Add Student
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-users"></i>
                        All Students
                        <span class="badge badge-info" id="studentsCount">Loading...</span>
                    </div>
                    <div id="studentsTable">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Exams Section -->
            <section id="exams" class="dashboard-section" style="display: none;">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search exams by title or subject..." 
                           onkeyup="searchExams(this.value)">
                    <button class="btn btn-primary" onclick="showAddExamModal()">
                        <i class="fas fa-plus"></i> Create Exam
                    </button>
                </div>

                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-file-alt"></i>
                        Exams & Results
                        <span class="badge badge-info" id="examsCount">Loading...</span>
                    </div>
                    <div id="examsTable">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Messages Section -->
            <section id="messages" class="dashboard-section" style="display: none;">
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Search messages by content or sender..." 
                           onkeyup="searchMessages(this.value)">
                    <select class="form-control" style="width: auto;" onchange="filterMessages(this.value)">
                        <option value="all">All Messages</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                    </select>
                </div>

                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-comments"></i>
                        Message History
                        <span class="badge badge-info" id="messagesCount">Loading...</span>
                    </div>
                    <div id="messagesTable">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Progress Analytics Section -->
            <section id="progress" class="dashboard-section" style="display: none;">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Student Progress Distribution</div>
                            <select class="form-control" style="width: auto; padding: 5px 10px;" onchange="loadProgressChart()">
                                <option value="level">By Level</option>
                                <option value="subject">By Subject</option>
                                <option value="status">By Status</option>
                            </select>
                        </div>
                        <canvas id="progressChart"></canvas>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top Performers</div>
                            <select class="form-control" style="width: auto; padding: 5px 10px;" onchange="loadTopPerformers()">
                                <option value="10" selected>Top 10</option>
                                <option value="20">Top 20</option>
                                <option value="50">Top 50</option>
                            </select>
                        </div>
                        <canvas id="topPerformersChart"></canvas>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-trophy"></i>
                        Leaderboard
                        <span class="badge badge-warning" id="leaderboardCount">Loading...</span>
                    </div>
                    <div id="leaderboardTable">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="dashboard-section" style="display: none;">
                <div class="table-container">
                    <div class="table-title">
                        <i class="fas fa-cog"></i>
                        Academy Settings
                    </div>
                    
                    <div style="padding: 20px;">
                        <form id="academySettingsForm">
                            <div class="form-group">
                                <label class="form-label">Academy Name</label>
                                <input type="text" class="form-control" id="academyName" value="Charles Academy">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Bot Name</label>
                                <input type="text" class="form-control" id="botName" value="Charles Academy Bot">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Support Phone Number</label>
                                <input type="text" class="form-control" id="supportPhone" value="255776831991">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Exam Settings</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                                    <div>
                                        <label class="form-label" style="font-size: 12px;">Time per question (seconds)</label>
                                        <input type="number" class="form-control" value="30" min="10" max="300">
                                    </div>
                                    <div>
                                        <label class="form-label" style="font-size: 12px;">Passing score (%)</label>
                                        <input type="number" class="form-control" value="70" min="50" max="100">
                                    </div>
                                </div>
                            </div>
                            
                            <div style="text-align: right; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
                                <button type="button" class="btn btn-secondary" onclick="resetSettings()">Reset to Default</button>
                                <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Student</div>
                <button class="modal-close" onclick="closeModal('addStudentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="form-group">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" id="studentName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" id="studentPhone" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="studentEmail">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Level/Grade</label>
                        <select class="form-control" id="studentLevel">
                            <option value="">Select Level</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveStudent()">Save Student</button>
            </div>
        </div>
    </div>

    <!-- Add Exam Modal -->
    <div id="addExamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Exam</div>
                <button class="modal-close" onclick="closeModal('addExamModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="examForm">
                    <div class="form-group">
                        <label class="form-label">Exam Title *</label>
                        <input type="text" class="form-control" id="examTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Subject *</label>
                        <select class="form-control" id="examSubject" required>
                            <option value="">Select Subject</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="english">English</option>
                            <option value="science">Science</option>
                            <option value="history">History</option>
                            <option value="geography">Geography</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Level</label>
                        <select class="form-control" id="examLevel">
                            <option value="all">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Number of Questions</label>
                        <input type="number" class="form-control" id="examQuestions" min="1" max="50" value="10">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Time Limit (minutes)</label>
                        <input type="number" class="form-control" id="examTime" min="1" max="180" value="30">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addExamModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveExam()">Create Exam</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== SUPABASE CONFIGURATION ====================
        const SUPABASE_URL = 'https://naycamtrebtnntoelucs.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_secret_vV554f6o45fEL-cuuBuoVw_SlguyoyH';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== GLOBAL VARIABLES ====================
        let enrollmentChart = null;
        let performanceChart = null;
        let progressChart = null;
        let topPerformersChart = null;
        let activeSection = 'dashboard';
        let allStudents = [];
        let allExams = [];
        let allMessages = [];
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìä Charles Academy Dashboard Initializing...');
            
            // Check Supabase connection
            try {
                const { data, error } = await supabase.from('students').select('count').limit(1);
                if (error) throw error;
                console.log('‚úÖ Supabase connection successful');
            } catch (error) {
                console.error('‚ùå Supabase connection error:', error);
                showNotification('Failed to connect to database. Using demo data.', 'warning');
            }
            
            // Load all data
            await loadAllData();
            
            // Initialize charts
            initCharts();
            
            // Update user info
            document.getElementById('userName').textContent = 'Admin';
        });
        
        // ==================== DATA LOADING FUNCTIONS ====================
        async function loadAllData() {
            try {
                // Load dashboard stats
                await loadDashboardStats();
                
                // Load enrollment data
                await loadEnrollmentData();
                
                // Load performance data
                await loadPerformanceData();
                
                // Load recent activity
                await loadRecentActivity();
                
            } catch (error) {
                console.error('Error loading all data:', error);
                showNotification('Error loading data. Please try again.', 'error');
            }
        }
        
        async function loadDashboardStats() {
            try {
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch counts from Supabase
                const [
                    { count: totalStudents, error: studentsError },
                    { count: activeExams, error: examsError },
                    { count: totalMessages, error: messagesError }
                ] = await Promise.all([
                    supabase.from('students').select('*', { count: 'exact', head: true }),
                    supabase.from('exams').select('*', { count: 'exact', head: true }).eq('status', 'active'),
                    supabase.from('messages').select('*', { count: 'exact', head: true })
                ]);
                
                if (studentsError || examsError || messagesError) {
                    throw new Error('Failed to fetch stats');
                }
                
                // Calculate average score (mock for now)
                const avgScore = await calculateAverageScore();
                
                // Update stats cards
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Students</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary), #667eea);">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value">${totalStudents || 0}</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading trend...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Active Exams</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, var(--secondary), #38b2ac);">
                                <i class="fas fa-file-alt"></i>
                            </div>
                        </div>
                        <div class="stat-value">${activeExams || 0}</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading trend...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Messages</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning), #ed8936);">
                                <i class="fas fa-comments"></i>
                            </div>
                        </div>
                        <div class="stat-value">${totalMessages || 0}</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading trend...</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Avg. Score</div>
                            <div class="stat-icon" style="background: linear-gradient(135deg, var(--success), #48bb78);">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                        <div class="stat-value">${avgScore}%</div>
                        <div class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>Loading trend...</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('statsGrid').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load statistics</p>
                        <button class="btn btn-secondary" onclick="loadDashboardStats()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function calculateAverageScore() {
            try {
                // Fetch exam results and calculate average
                const { data: results, error } = await supabase
                    .from('exam_results')
                    .select('score')
                    .limit(100);
                
                if (error) throw error;
                
                if (!results || results.length === 0) return '0';
                
                const total = results.reduce((sum, result) => sum + (parseFloat(result.score) || 0), 0);
                const average = (total / results.length).toFixed(1);
                return average;
            } catch (error) {
                console.error('Error calculating average score:', error);
                return '0';
            }
        }
        
        async function loadEnrollmentData() {
            try {
                const period = document.getElementById('enrollmentPeriod').value;
                const days = parseInt(period);
                
                // Calculate date range
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                
                // Format dates for Supabase
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                // Fetch enrollment data
                const { data: enrollments, error } = await supabase
                    .from('students')
                    .select('created_at')
                    .gte('created_at', startDateStr)
                    .lte('created_at', endDateStr);
                
                if (error) throw error;
                
                // Process data for chart
                const dates = {};
                const currentDate = new Date(startDate);
                
                // Initialize dates object
                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    dates[dateStr] = 0;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Count enrollments per day
                enrollments?.forEach(enrollment => {
                    if (enrollment.created_at) {
                        const date = enrollment.created_at.split('T')[0];
                        if (dates[date] !== undefined) {
                            dates[date]++;
                        }
                    }
                });
                
                // Prepare chart data
                const labels = Object.keys(dates).map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                
                const values = Object.values(dates);
                
                // Update chart
                updateEnrollmentChart(labels, values);
                
            } catch (error) {
                console.error('Error loading enrollment data:', error);
                showNotification('Failed to load enrollment data', 'error');
                
                // Use sample data if API fails
                const sampleLabels = ['Jan 1', 'Jan 2', 'Jan 3', 'Jan 4', 'Jan 5', 'Jan 6', 'Jan 7'];
                const sampleValues = [5, 8, 12, 7, 15, 10, 18];
                updateEnrollmentChart(sampleLabels, sampleValues);
            }
        }
        
        async function loadPerformanceData() {
            try {
                const period = document.getElementById('examPeriod').value;
                
                // Fetch exam performance data
                const { data: exams, error } = await supabase
                    .from('exams')
                    .select('subject, average_score')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                // Process data for chart
                const subjects = {};
                exams?.forEach(exam => {
                    if (exam.subject && exam.average_score) {
                        if (!subjects[exam.subject]) {
                            subjects[exam.subject] = [];
                        }
                        subjects[exam.subject].push(parseFloat(exam.average_score));
                    }
                });
                
                // Calculate average per subject
                const labels = Object.keys(subjects);
                const averages = labels.map(subject => {
                    const scores = subjects[subject];
                    const average = scores.reduce((a, b) => a + b, 0) / scores.length;
                    return Math.round(average);
                });
                
                // Update chart
                updatePerformanceChart(labels, averages);
                
            } catch (error) {
                console.error('Error loading performance data:', error);
                showNotification('Failed to load performance data', 'error');
                
                // Use sample data
                const sampleLabels = ['Math', 'English', 'Science', 'History', 'Geography'];
                const sampleValues = [78, 85, 72, 90, 68];
                updatePerformanceChart(sampleLabels, sampleValues);
            }
        }
        
        async function loadRecentActivity() {
            try {
                const recentActivity = document.getElementById('recentActivity');
                recentActivity.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch recent activity from multiple tables
                const [
                    { data: recentExams, error: examsError },
                    { data: recentStudents, error: studentsError },
                    { data: recentMessages, error: messagesError }
                ] = await Promise.all([
                    supabase
                        .from('exam_results')
                        .select(`
                            score,
                            completed_at,
                            student:students(name),
                            exam:exams(title)
                        `)
                        .order('completed_at', { ascending: false })
                        .limit(5),
                    
                    supabase
                        .from('students')
                        .select('name, phone, created_at')
                        .order('created_at', { ascending: false })
                        .limit(3),
                    
                    supabase
                        .from('messages')
                        .select('content, sender, timestamp')
                        .order('timestamp', { ascending: false })
                        .limit(2)
                ]);
                
                if (examsError || studentsError || messagesError) {
                    throw new Error('Failed to fetch recent activity');
                }
                
                // Combine and sort all activities
                const activities = [];
                
                // Add exam completions
                recentExams?.forEach(exam => {
                    activities.push({
                        type: 'exam',
                        user: exam.student?.name || 'Student',
                        action: `completed ${exam.exam?.title || 'exam'}`,
                        score: `${exam.score}%`,
                        time: formatTimeAgo(exam.completed_at)
                    });
                });
                
                // Add new students
                recentStudents?.forEach(student => {
                    activities.push({
                        type: 'student',
                        user: student.name || 'New Student',
                        action: 'registered',
                        score: '--',
                        time: formatTimeAgo(student.created_at)
                    });
                });
                
                // Add recent messages
                recentMessages?.forEach(message => {
                    activities.push({
                        type: 'message',
                        user: message.sender === 'bot' ? 'Bot' : 'Student',
                        action: `sent message: ${message.content?.substring(0, 30)}...`,
                        score: '--',
                        time: formatTimeAgo(message.timestamp)
                    });
                });
                
                // Sort by time (newest first)
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Render activities
                if (activities.length === 0) {
                    recentActivity.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No recent activity found</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Activity</th>
                                <th>Score</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                activities.slice(0, 8).forEach(activity => {
                    const initials = activity.user.split(' ').map(n => n[0]).join('').toUpperCase();
                    const icon = activity.type === 'exam' ? 'fa-file-alt' : 
                                 activity.type === 'student' ? 'fa-user-plus' : 'fa-comment';
                    
                    html += `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                        <i class="fas ${icon}"></i>
                                    </div>
                                    <span>${activity.user}</span>
                                </div>
                            </td>
                            <td>${activity.action}</td>
                            <td>
                                <span class="badge ${activity.score === '--' ? 'badge-info' : 'badge-success'}">
                                    ${activity.score}
                                </span>
                            </td>
                            <td style="color: var(--text-secondary); font-size: 13px;">
                                ${activity.time}
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                recentActivity.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading recent activity:', error);
                document.getElementById('recentActivity').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load recent activity</p>
                        <button class="btn btn-secondary" onclick="loadRecentActivity()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function loadStudentsData() {
            try {
                const studentsTable = document.getElementById('studentsTable');
                studentsTable.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch all students from Supabase
                const { data: students, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allStudents = students || [];
                
                // Update count
                document.getElementById('studentsCount').textContent = `${allStudents.length} students`;
                
                // Render table
                if (allStudents.length === 0) {
                    studentsTable.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users-slash"></i>
                            <p>No students found</p>
                            <button class="btn btn-primary" onclick="showAddStudentModal()">Add First Student</button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Phone</th>
                                <th>Level</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                allStudents.forEach(student => {
                    const initials = student.name ? student.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                    const status = student.status || 'active';
                    const level = student.level || 'beginner';
                    const joined = student.created_at ? new Date(student.created_at).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td>#${student.id || 'N/A'}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                        ${initials}
                                    </div>
                                    <span>${student.name || 'Unknown'}</span>
                                </div>
                            </td>
                            <td>${student.phone || 'N/A'}</td>
                            <td>
                                <span class="badge ${level === 'beginner' ? 'badge-info' : level === 'intermediate' ? 'badge-warning' : 'badge-success'}">
                                    ${level}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${status === 'active' ? 'badge-success' : 'badge-danger'}">
                                    ${status}
                                </span>
                            </td>
                            <td>${joined}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewStudent(${student.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editStudent(${student.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                studentsTable.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTable').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load students</p>
                        <button class="btn btn-secondary" onclick="loadStudentsData()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function loadExamsData() {
            try {
                const examsTable = document.getElementById('examsTable');
                examsTable.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch all exams from Supabase
                const { data: exams, error } = await supabase
                    .from('exams')
                    .select(`
                        *,
                        results:exam_results(count)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allExams = exams || [];
                
                // Update count
                document.getElementById('examsCount').textContent = `${allExams.length} exams`;
                
                // Render table
                if (allExams.length === 0) {
                    examsTable.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>No exams found</p>
                            <button class="btn btn-primary" onclick="showAddExamModal()">Create First Exam</button>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Subject</th>
                                <th>Level</th>
                                <th>Status</th>
                                <th>Avg Score</th>
                                <th>Participants</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                allExams.forEach(exam => {
                    const status = exam.status || 'draft';
                    const avgScore = exam.average_score ? `${exam.average_score}%` : 'N/A';
                    const participants = exam.results?.length || 0;
                    
                    html += `
                        <tr>
                            <td>#${exam.id || 'N/A'}</td>
                            <td>${exam.title || 'Untitled'}</td>
                            <td>
                                <span class="badge badge-info">
                                    ${exam.subject || 'General'}
                                </span>
                            </td>
                            <td>${exam.level || 'All'}</td>
                            <td>
                                <span class="badge ${status === 'active' ? 'badge-success' : status === 'draft' ? 'badge-warning' : 'badge-danger'}">
                                    ${status}
                                </span>
                            </td>
                            <td>${avgScore}</td>
                            <td>${participants}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewExam(${exam.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="editExam(${exam.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                examsTable.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading exams:', error);
                document.getElementById('examsTable').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load exams</p>
                        <button class="btn btn-secondary" onclick="loadExamsData()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function loadMessagesData() {
            try {
                const messagesTable = document.getElementById('messagesTable');
                messagesTable.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch recent messages from Supabase
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(100);
                
                if (error) throw error;
                
                allMessages = messages || [];
                
                // Update count
                document.getElementById('messagesCount').textContent = `${allMessages.length} messages`;
                
                // Render table
                if (allMessages.length === 0) {
                    messagesTable.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>No messages found</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sender</th>
                                <th>Message</th>
                                <th>Session</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                allMessages.forEach(message => {
                    const sender = message.sender || 'unknown';
                    const isBot = sender === 'bot';
                    const time = message.timestamp ? new Date(message.timestamp).toLocaleString() : 'N/A';
                    const content = message.content ? 
                        (message.content.length > 50 ? message.content.substring(0, 50) + '...' : message.content) : 
                        'Empty message';
                    
                    html += `
                        <tr>
                            <td>#${message.id || 'N/A'}</td>
                            <td>
                                <span class="badge ${isBot ? 'badge-info' : 'badge-success'}">
                                    ${isBot ? 'ü§ñ Bot' : 'üë§ Student'}
                                </span>
                            </td>
                            <td title="${message.content || ''}">${content}</td>
                            <td style="font-family: monospace; font-size: 12px;">
                                ${message.session_id ? message.session_id.substring(0, 8) + '...' : 'N/A'}
                            </td>
                            <td style="color: var(--text-secondary); font-size: 13px;">
                                ${time}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="viewMessage(${message.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteMessage(${message.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                messagesTable.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('messagesTable').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load messages</p>
                        <button class="btn btn-secondary" onclick="loadMessagesData()">Retry</button>
                    </div>
                `;
            }
        }
        
        async function loadLeaderboardData() {
            try {
                const leaderboardTable = document.getElementById('leaderboardTable');
                leaderboardTable.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                `;
                
                // Fetch top performers from exam results
                const { data: results, error } = await supabase
                    .from('exam_results')
                    .select(`
                        score,
                        student:students(name, phone),
                        exam:exams(title, subject)
                    `)
                    .order('score', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                // Update count
                document.getElementById('leaderboardCount').textContent = `${results?.length || 0} top performers`;
                
                // Render table
                if (!results || results.length === 0) {
                    leaderboardTable.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>No exam results found</p>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Student</th>
                                <th>Exam</th>
                                <th>Subject</th>
                                <th>Score</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>`;
                
                results.forEach((result, index) => {
                    const rank = index + 1;
                    const studentName = result.student?.name || 'Unknown Student';
                    const examTitle = result.exam?.title || 'Unknown Exam';
                    const subject = result.exam?.subject || 'General';
                    const score = result.score || 0;
                    
                    // Get rank badge color
                    let rankBadge = '';
                    if (rank === 1) {
                        rankBadge = '<span style="color: gold; font-weight: bold;">ü•á</span>';
                    } else if (rank === 2) {
                        rankBadge = '<span style="color: silver; font-weight: bold;">ü•à</span>';
                    } else if (rank === 3) {
                        rankBadge = '<span style="color: #cd7f32; font-weight: bold;">ü•â</span>';
                    } else {
                        rankBadge = `<span class="badge badge-info">#${rank}</span>`;
                    }
                    
                    html += `
                        <tr>
                            <td>${rankBadge}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                        ${studentName.split(' ').map(n => n[0]).join('').toUpperCase()}
                                    </div>
                                    <span>${studentName}</span>
                                </div>
                            </td>
                            <td>${examTitle}</td>
                            <td>
                                <span class="badge badge-info">
                                    ${subject}
                                </span>
                            </td>
                            <td>
                                <span class="badge ${score >= 80 ? 'badge-success' : score >= 60 ? 'badge-warning' : 'badge-danger'}">
                                    ${score}%
                                </span>
                            </td>
                            <td style="color: var(--text-secondary); font-size: 13px;">
                                Recently
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                leaderboardTable.innerHTML = html;
                
                // Also update top performers chart
                updateTopPerformersChart(results.slice(0, 10));
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                document.getElementById('leaderboardTable').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to load leaderboard</p>
                        <button class="btn btn-secondary" onclick="loadLeaderboardData()">Retry</button>
                    </div>
                `;
            }
        }
        
        // ==================== CHART FUNCTIONS ====================
        function initCharts() {
            // Initialize charts with empty data
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#8f98a3' }
                    },
                    y: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#8f98a3' }
                    }
                }
            };
            
            // Enrollment Chart (Line)
            const enrollCtx = document.getElementById('enrollmentChart').getContext('2d');
            enrollmentChart = new Chart(enrollCtx, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: chartOptions
            });
            
            // Performance Chart (Bar)
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: chartOptions
            });
            
            // Progress Chart (Doughnut)
            const progCtx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(progCtx, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#ffffff' } } }
                }
            });
            
            // Top Performers Chart (Bar - horizontal)
            const topCtx = document.getElementById('topPerformersChart').getContext('2d');
            topPerformersChart = new Chart(topCtx, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    ...chartOptions,
                    indexAxis: 'y'
                }
            });
        }
        
        function updateEnrollmentChart(labels, values) {
            if (!enrollmentChart) return;
            
            enrollmentChart.data = {
                labels: labels,
                datasets: [{
                    label: 'New Students',
                    data: values,
                    borderColor: '#0088cc',
                    backgroundColor: 'rgba(0, 136, 204, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            };
            enrollmentChart.update();
        }
        
        function updatePerformanceChart(labels, values) {
            if (!performanceChart) return;
            
            performanceChart.data = {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: values,
                    backgroundColor: [
                        'rgba(0, 136, 204, 0.8)',
                        'rgba(0, 168, 132, 0.8)',
                        'rgba(249, 202, 36, 0.8)',
                        'rgba(155, 89, 182, 0.8)',
                        'rgba(46, 204, 113, 0.8)'
                    ],
                    borderColor: [
                        '#0088cc',
                        '#00a884',
                        '#f9ca24',
                        '#9b59b6',
                        '#2ecc71'
                    ],
                    borderWidth: 1
                }]
            };
            performanceChart.update();
        }
        
        function updateTopPerformersChart(results) {
            if (!topPerformersChart || !results) return;
            
            const labels = results.map(r => r.student?.name || 'Student').slice(0, 10);
            const scores = results.map(r => r.score || 0).slice(0, 10);
            
            topPerformersChart.data = {
                labels: labels,
                datasets: [{
                    label: 'Score (%)',
                    data: scores,
                    backgroundColor: scores.map(score => 
                        score >= 80 ? 'rgba(46, 204, 113, 0.8)' :
                        score >= 60 ? 'rgba(249, 202, 36, 0.8)' :
                        'rgba(235, 77, 75, 0.8)'
                    ),
                    borderColor: scores.map(score => 
                        score >= 80 ? '#2ecc71' :
                        score >= 60 ? '#f9ca24' :
                        '#eb4d4b'
                    ),
                    borderWidth: 1
                }]
            };
            topPerformersChart.update();
        }
        
        async function loadProgressChart() {
            try {
                // Fetch student progress data
                const { data: students, error } = await supabase
                    .from('students')
                    .select('level, progress');
                
                if (error) throw error;
                
                // Count students by level
                const levelCounts = { beginner: 0, intermediate: 0, advanced: 0 };
                students?.forEach(student => {
                    const level = student.level || 'beginner';
                    levelCounts[level] = (levelCounts[level] || 0) + 1;
                });
                
                // Update chart
                progressChart.data = {
                    labels: ['Beginner', 'Intermediate', 'Advanced'],
                    datasets: [{
                        data: [levelCounts.beginner, levelCounts.intermediate, levelCounts.advanced],
                        backgroundColor: ['#0088cc', '#00a884', '#f9ca24'],
                        borderWidth: 0
                    }]
                };
                progressChart.update();
                
            } catch (error) {
                console.error('Error loading progress chart:', error);
            }
        }
        
        async function loadTopPerformers() {
            await loadLeaderboardData();
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Unknown time';
            
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins !== 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            
            return date.toLocaleDateString();
        }
        
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).style.display = 'block';
            
            // Add active class to clicked nav link
            event.target.closest('.nav-link').classList.add('active');
            
            // Update active section
            activeSection = sectionId;
            
            // Update page title
            updatePageTitle(sectionId);
            
            // Load section data if needed
            switch (sectionId) {
                case 'students':
                    loadStudentsData();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'messages':
                    loadMessagesData();
                    break;
                case 'progress':
                    loadLeaderboardData();
                    loadProgressChart();
                    break;
            }
        }
        
        function updatePageTitle(section) {
            const titles = {
                'dashboard': 'Dashboard Overview',
                'students': 'Student Management',
                'exams': 'Exams & Results',
                'messages': 'Message History',
                'progress': 'Progress Analytics',
                'settings': 'Settings'
            };
            
            const subtitles = {
                'dashboard': 'Real-time data from your academy',
                'students': 'Manage student information and enrollment',
                'exams': 'Create and monitor exams and results',
                'messages': 'View and analyze chat history',
                'progress': 'Track student learning progress',
                'settings': 'Configure academy settings'
            };
            
            document.getElementById('pageTitle').textContent = titles[section];
            document.getElementById('pageSubtitle').textContent = subtitles[section];
        }
        
        function refreshData() {
            showNotification('Refreshing data...', 'info');
            
            switch (activeSection) {
                case 'dashboard':
                    loadDashboardStats();
                    loadEnrollmentData();
                    loadPerformanceData();
                    loadRecentActivity();
                    break;
                case 'students':
                    loadStudentsData();
                    break;
                case 'exams':
                    loadExamsData();
                    break;
                case 'messages':
                    loadMessagesData();
                    break;
                case 'progress':
                    loadLeaderboardData();
                    loadProgressChart();
                    break;
            }
        }
        
        // ==================== MODAL FUNCTIONS ====================
        function showAddStudentModal() {
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function showAddExamModal() {
            document.getElementById('addExamModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // ==================== CRUD OPERATIONS ====================
        async function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const level = document.getElementById('studentLevel').value;
            
            if (!name || !phone) {
                showNotification('Name and phone number are required', 'error');
                return;
            }
            
            try {
                // Insert new student into Supabase
                const { data, error } = await supabase
                    .from('students')
                    .insert([{
                        name: name,
                        phone: phone,
                        email: email || null,
                        level: level || 'beginner',
                        status: 'active',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                showNotification('Student added successfully!', 'success');
                closeModal('addStudentModal');
                
                // Clear form
                document.getElementById('studentName').value = '';
                document.getElementById('studentPhone').value = '';
                document.getElementById('studentEmail').value = '';
                document.getElementById('studentLevel').value = '';
                
                // Refresh students list
                if (activeSection === 'students') {
                    loadStudentsData();
                }
                // Refresh dashboard stats
                loadDashboardStats();
                
            } catch (error) {
                console.error('Error saving student:', error);
                showNotification('Failed to add student: ' + error.message, 'error');
            }
        }
        
        async function saveExam() {
            const title = document.getElementById('examTitle').value.trim();
            const subject = document.getElementById('examSubject').value;
            const level = document.getElementById('examLevel').value;
            const questions = document.getElementById('examQuestions').value;
            const time = document.getElementById('examTime').value;
            
            if (!title || !subject) {
                showNotification('Title and subject are required', 'error');
                return;
            }
            
            try {
                // Insert new exam into Supabase
                const { data, error } = await supabase
                    .from('exams')
                    .insert([{
                        title: title,
                        subject: subject,
                        level: level || 'all',
                        question_count: parseInt(questions) || 10,
                        time_limit: parseInt(time) || 30,
                        status: 'draft',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                showNotification('Exam created successfully!', 'success');
                closeModal('addExamModal');
                
                // Clear form
                document.getElementById('examTitle').value = '';
                document.getElementById('examSubject').value = '';
                document.getElementById('examLevel').value = 'all';
                document.getElementById('examQuestions').value = '10';
                document.getElementById('examTime').value = '30';
                
                // Refresh exams list
                if (activeSection === 'exams') {
                    loadExamsData();
                }
                
            } catch (error) {
                console.error('Error saving exam:', error);
                showNotification('Failed to create exam: ' + error.message, 'error');
            }
        }
        
        function saveSettings() {
            // In a real app, you would save these to Supabase
            showNotification('Settings saved successfully!', 'success');
        }
        
        function resetSettings() {
            document.getElementById('academyName').value = 'Charles Academy';
            document.getElementById('botName').value = 'Charles Academy Bot';
            document.getElementById('supportPhone').value = '255776831991';
            showNotification('Settings reset to default', 'info');
        }
        
        // ==================== VIEW/EDIT/DELETE FUNCTIONS ====================
        function viewStudent(id) {
            showNotification(`Viewing student #${id} - Feature coming soon`, 'info');
        }
        
        function editStudent(id) {
            showNotification(`Editing student #${id} - Feature coming soon`, 'info');
        }
        
        function viewExam(id) {
            showNotification(`Viewing exam #${id} - Feature coming soon`, 'info');
        }
        
        function editExam(id) {
            showNotification(`Editing exam #${id} - Feature coming soon`, 'info');
        }
        
        function viewMessage(id) {
            showNotification(`Viewing message #${id} - Feature coming soon`, 'info');
        }
        
        async function deleteMessage(id) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            
            try {
                const { error } = await supabase
                    .from('messages')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showNotification('Message deleted successfully', 'success');
                loadMessagesData();
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showNotification('Failed to delete message', 'error');
            }
        }
        
        // ==================== SEARCH FUNCTIONS ====================
        function searchStudents(query) {
            if (!query.trim()) {
                // Show all students if query is empty
                renderStudentsTable(allStudents);
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const filtered = allStudents.filter(student => 
                (student.name && student.name.toLowerCase().includes(searchTerm)) ||
                (student.phone && student.phone.includes(searchTerm)) ||
                (student.email && student.email.toLowerCase().includes(searchTerm)) ||
                (student.level && student.level.toLowerCase().includes(searchTerm))
            );
            
            renderStudentsTable(filtered);
        }
        
        function searchExams(query) {
            if (!query.trim()) {
                renderExamsTable(allExams);
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const filtered = allExams.filter(exam => 
                (exam.title && exam.title.toLowerCase().includes(searchTerm)) ||
                (exam.subject && exam.subject.toLowerCase().includes(searchTerm)) ||
                (exam.level && exam.level.toLowerCase().includes(searchTerm))
            );
            
            renderExamsTable(filtered);
        }
        
        function searchMessages(query) {
            if (!query.trim()) {
                renderMessagesTable(allMessages);
                return;
            }
            
            const searchTerm = query.toLowerCase();
            const filtered = allMessages.filter(message => 
                (message.content && message.content.toLowerCase().includes(searchTerm)) ||
                (message.sender && message.sender.toLowerCase().includes(searchTerm))
            );
            
            renderMessagesTable(filtered);
        }
        
        function filterMessages(filter) {
            if (filter === 'all') {
                renderMessagesTable(allMessages);
                return;
            }
            
            const now = new Date();
            let startDate = new Date();
            
            switch (filter) {
                case 'today':
                    startDate.setHours(0, 0, 0, 0);
                    break;
                case 'week':
                    startDate.setDate(now.getDate() - 7);
                    break;
                case 'month':
                    startDate.setMonth(now.getMonth() - 1);
                    break;
            }
            
            const filtered = allMessages.filter(message => {
                if (!message.timestamp) return false;
                const messageDate = new Date(message.timestamp);
                return messageDate >= startDate;
            });
            
            renderMessagesTable(filtered);
        }
        
        function renderStudentsTable(students) {
            const studentsTable = document.getElementById('studentsTable');
            if (!students || students.length === 0) {
                studentsTable.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No students match your search</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Phone</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            students.forEach(student => {
                const initials = student.name ? student.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                const status = student.status || 'active';
                const level = student.level || 'beginner';
                const joined = student.created_at ? new Date(student.created_at).toLocaleDateString() : 'N/A';
                
                html += `
                    <tr>
                        <td>#${student.id || 'N/A'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">
                                    ${initials}
                                </div>
                                <span>${student.name || 'Unknown'}</span>
                            </div>
                        </td>
                        <td>${student.phone || 'N/A'}</td>
                        <td>
                            <span class="badge ${level === 'beginner' ? 'badge-info' : level === 'intermediate' ? 'badge-warning' : 'badge-success'}">
                                ${level}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${status === 'active' ? 'badge-success' : 'badge-danger'}">
                                ${status}
                            </span>
                        </td>
                        <td>${joined}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewStudent(${student.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editStudent(${student.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            studentsTable.innerHTML = html;
        }
        
        function renderExamsTable(exams) {
            const examsTable = document.getElementById('examsTable');
            if (!exams || exams.length === 0) {
                examsTable.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No exams match your search</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Subject</th>
                            <th>Level</th>
                            <th>Status</th>
                            <th>Avg Score</th>
                            <th>Participants</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            exams.forEach(exam => {
                const status = exam.status || 'draft';
                const avgScore = exam.average_score ? `${exam.average_score}%` : 'N/A';
                const participants = exam.results?.length || 0;
                
                html += `
                    <tr>
                        <td>#${exam.id || 'N/A'}</td>
                        <td>${exam.title || 'Untitled'}</td>
                        <td>
                            <span class="badge badge-info">
                                ${exam.subject || 'General'}
                            </span>
                        </td>
                        <td>${exam.level || 'All'}</td>
                        <td>
                            <span class="badge ${status === 'active' ? 'badge-success' : status === 'draft' ? 'badge-warning' : 'badge-danger'}">
                                ${status}
                            </span>
                        </td>
                        <td>${avgScore}</td>
                        <td>${participants}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewExam(${exam.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="editExam(${exam.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            examsTable.innerHTML = html;
        }
        
        function renderMessagesTable(messages) {
            const messagesTable = document.getElementById('messagesTable');
            if (!messages || messages.length === 0) {
                messagesTable.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No messages match your search</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Sender</th>
                            <th>Message</th>
                            <th>Session</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            messages.forEach(message => {
                const sender = message.sender || 'unknown';
                const isBot = sender === 'bot';
                const time = message.timestamp ? new Date(message.timestamp).toLocaleString() : 'N/A';
                const content = message.content ? 
                    (message.content.length > 50 ? message.content.substring(0, 50) + '...' : message.content) : 
                    'Empty message';
                
                html += `
                    <tr>
                        <td>#${message.id || 'N/A'}</td>
                        <td>
                            <span class="badge ${isBot ? 'badge-info' : 'badge-success'}">
                                ${isBot ? 'ü§ñ Bot' : 'üë§ Student'}
                            </span>
                        </td>
                        <td title="${message.content || ''}">${content}</td>
                        <td style="font-family: monospace; font-size: 12px;">
                            ${message.session_id ? message.session_id.substring(0, 8) + '...' : 'N/A'}
                        </td>
                        <td style="color: var(--text-secondary); font-size: 13px;">
                            ${time}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="viewMessage(${message.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteMessage(${message.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            messagesTable.innerHTML = html;
        }
        
        // ==================== NOTIFICATION FUNCTION ====================
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: '#00a884',
                error: '#eb4d4b',
                warning: '#f9ca24',
                info: '#0088cc'
            };
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: ${colors[type]}; 
                    color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
                    z-index: 9999; display: flex; align-items: center; gap: 10px; animation: slideInRight 0.3s ease;">
                    <i class="fas ${icons[type]}"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add CSS for notification animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Initial data load
        loadAllData();
    </script>
</body>
</html>